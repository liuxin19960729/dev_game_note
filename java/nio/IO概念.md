# IO概念
```
jdk 1.4 引入nio

```

## 缓冲区操作
```
进程IO操作--> 向 os kernel 发出操作请求--> os 接收到请求 操作对应的驱动(网络 disk)-->写 buff数据向驱动写 读把驱动硬件的数据读取到buf里面。



例 进程执行 read()函数到disk(磁盘读取数据)

read() 用户态-->切换到内核 -->向磁盘发出指令

磁盘接收到指令-->磁盘控制器把数据写到缓冲区(DMA完成和cpu无关)-->缓冲区数据装满

内核操作  内核的临时缓冲区-->把数据拷贝到用户指令的缓冲区



内核可能会进行预读取数据 把数据放到内核的缓冲区
当我们执行read()的时候有可能不需要进行磁盘数据读取，直接到缓存里面拿预读取缓存的数据



为什么硬件不把数据直接放到用户空间的缓存?
    1.硬件不能访问用户空间
    2.磁盘的数据块大小是固定的(也就是说每次读都只能读以数据块为单位大小)
       用户读取数据大小是不固定的 ，若直接读取可能读取数据大小不准确 可能多度少读 这种情况

       而 os kernel 他不仅能访问硬件 他还是个管理者 读取磁盘里面的数据 然后根据用户的请求要求对数据进行分割 组合，这样用户拿到的数据就是用户需要的数据   注意：os kernel 充当的是管理者 中间人的角色
       
```

## 发散 / 汇聚
```
作用  os使缓冲区的数据组装和分解更加高效

调用read() write() 可以指定多个缓冲地址

os 能同时把数据读到多个缓冲 也能把多个缓动写出去

若有多个cpu 多个cpu可以同时的做这件事情 这样性能更加的好
优点 不用频繁的用户和内核态的切换(切换是一个非常消耗性能的过程)


```


## 虚拟内存

```
使用虚拟地址取代物理地址

一个以上的地址可以指定同一个物理地址
虚拟空间实际大于硬件内存


虚拟内存 和物理地址映射的地址都是经常使用的数据和指令
其余的不常用的起始是放在磁盘里面的
当要使用那一部分的时候 会把一部分不常用的存放到磁盘，再把马上要用的加载存来放入到物理内存，是虚拟内存的位置在存入的物理内存位置进行映射


虚拟内存页的大小是内存磁盘扇区大小的倍数





MMU 子系统
  位置：cpu 和内存之间

  作用 虚拟地址-->物理地址的映射信息管理

  cpu 执行需要地址的信息--->虚拟地址--->mmu(进行计算)-->返回真实的物理地址-->cpu寻址
  当这个虚拟地址映射到粗物理地址不存在 mmu 向cpu提交错误

  cpu 拿到这个错误，将控制权交给内核(联通出错的虚拟地址 页信息)-->检验页的有效性
    有效
        内核会在磁盘把缺失的页读取到内存-->别的不常用的页也会被存入到内存(给新来的让位)

        页面移除内存的过程中若该内存区域的数据被修改过(和上一次的调出内容进行比较) 还必须执行调出后，还要把他修改的内容同步到磁盘里面去


        若没有修改 就可以直接使用掉来的数据对这块内存区域直接进行覆盖
    

    无效
        错误产生 错误错误异常 ，进程会被os强制进行关闭    



  数据加载完成 出错页通过验证 mmu 更新新的映射信息


```



## 文件IO
```
文件系统 
      把连串的数据组织到一起
      他会把员信息和目录 索引 映射 等信息 收集起来管理

      比如 单个文件 文件数据 存储在那些磁盘数据块里面 带哪里结束




用户进程读取文件IO的流程(执行IO操作系统的分页技术)

1.确认请求数据分布在文件系统的那些页(磁盘扇区组)
    注意：当我们请求一个文件的时候 他的信息分布在可能不是同一页 ，这些页可能也不是连续的
2.操作系统给文件也分配的内存页完全足够存储

3.内存页--磁盘上的文件页 创建映射关系




大多数操作系统额外的预读剩余文件系统页 会把文件缓存到里面 内存竞争不严重的情况下回保留的时间较长

write 文件内容  文件系统页变脏  页面调出  与磁盘进行数据同步


文件创建  
   把文件映射到空的文件系统页--写操作中  --将数据刷新到磁盘





```

## 内存映射IO
```
建立用户空间 和文件系统页的映射


```

## 文件锁定
```
允许一个进程阻止其他进程对文件的读取，或写入

锁定可以细致到某一个字节 为了多进程操作同一个文件的不同区域


锁定方式
   1.共享锁
        可同时对同一个文件的区域发生作用


   2.独占锁
        相关区域不能有其他锁起作用


        
```